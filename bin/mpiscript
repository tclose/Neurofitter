#!/bin/bash

# Send mail at begin and end of job
# -M werner@tnb.ua.ac.be
#$ -m bae

# -l arch=g5
#$ -j y

#$ -o /cluster/home/werner/joboutputs

#$ -q normal.q 
#$ -pe mpichtight 22

#$ -v MPICH_HOME=/cluster/sw/mpich,SGE_QMASTER_PORT=536,MPICH_PROCESS_GROUP=no
#$ -V

HOME=/cluster/home/$USER

###################################################
### Copy the model to all machines we are using ###
###################################################
#rshcmd=/Library/GridEngine/mpi/rsh
rshcmd=/Library/GridEngine/utilbin/darwin/rsh

scratchBase=/cluster/scratch/local/$USER/NeurofitterWork

echo "Creating scratch directory on:"
i=0
for machine in `cat $TMPDIR/machines`; 
do
  scratch=${scratchBase}_${JOB_ID}_${i};
  echo $machine ":" $scratch;
  $rshcmd $machine mkdir -p ${scratch};
  $rshcmd $machine mkdir -p ${scratch}/genesisoutput;
  $rshcmd $machine mkdir -p ${scratchBase}_${JOB_ID};
  $rshcmd $machine cp -rf $HOME/EvolufitWork/wernermodel $scratch/genesisoutput;
  $rshcmd $machine cp -rf $HOME/EvolufitWork/Evolufit/bin $scratch;
  $rshcmd $machine "sed s#NEUROFITTERSCRATCH#${scratch}# $HOME/EvolufitWork/Evolufit/bin/mpiparameters.xml >${scratchBase}_${JOB_ID}/mpiparameters.xml_${i}"
  i=`expr $i + 1`;
done;
echo

/cluster/sw/mpich/bin/mpirun -machinefile $TMPDIR/machines -np $NSLOTS $HOME/EvolufitWork/Evolufit/bin/MPIEvolufit ${scratchBase}_${JOB_ID}/mpiparameters.xml

echo
echo "Removing scratch directory from:"
i=0
for machine in `cat $TMPDIR/machines`;
do
  scratch=${scratchBase}_${JOB_ID}_${i};
  echo $machine ":" $scratch;
  $rshcmd $machine rm -rf $scratch;
  $rshcmd $machine rm -f ${scratchBase}_${JOB_ID}/mpiparameters.xml_${i};
  i=`expr $i + 1`;
done;

# END



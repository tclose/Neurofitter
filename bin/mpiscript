#!/bin/bash

# Send mail at begin and end of job
# -M werner@tnb.ua.ac.be
#$ -m bae

# -l arch=g5
#$ -j y

#$ -o /cluster/home/werner/joboutputs

#$ -q normal.q 
#$ -pe mpichtight 10

#$ -v MPICH_HOME=/cluster/sw/mpich,SGE_QMASTER_PORT=536,MPICH_PROCESS_GROUP=no
#$ -V

HOME=/cluster/home/$USER

###################################################
### Copy the model to all machines we are using ###
###################################################
#rshcmd=/Library/GridEngine/mpi/rsh
rshcmd=/Library/GridEngine/utilbin/darwin/rsh

scratch=/cluster/scratch/local/$USER/EvoOutput
#sort -u -o ./Machinelist $TMPDIR/machines 

echo "Creating scratch directory on:"
for machine in `sort -u $TMPDIR/machines`; 
do
  echo $machine;
  $rshcmd $machine mkdir -p $scratch;
  $rshcmd $machine mkdir -p $scratch/genesisoutput;
  $rshcmd $machine cp -rf $HOME/EvolufitWork/wernermodel $scratch/genesisoutput;
  $rshcmd $machine cp -rf $HOME/EvolufitWork/Evolufit/bin $scratch;
done;
echo

EVOLUBINDIR=$scratch/bin

/cluster/sw/mpich/bin/mpirun -machinefile $TMPDIR/machines -np $NSLOTS $EVOLUBINDIR/MPIEvolufit $EVOLUBINDIR/mpiparameters.xml

echo
echo "Removing scratch directory from:"
for machine in `sort -u $TMPDIR/machines`;
do
  echo $machine
  $rshcmd $machine rm -rf $scratch
done;

# END

